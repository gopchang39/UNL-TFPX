<!DOCTYPE html>
<html>
<head>
    <title>Module Production Checklist</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f8f9fa; font-size: 12px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th { background: #2c3e50; color: white; padding: 10px; position: sticky; top: 0; }
        td { border: 1px solid #dee2e6; padding: 5px; vertical-align: top; }
        
        /* Cell Layout */
        .cell-container { display: flex; flex-direction: column; gap: 3px; min-width: 160px; }
        input[type="datetime-local"], select { font-size: 11px; padding: 2px; border: 1px solid #ccc; border-radius: 3px; }
        
        /* Note Window with Corner Button */
        .note-wrapper { position: relative; width: 100%; }
        textarea { width: 100%; height: 50px; font-size: 11px; padding: 4px; box-sizing: border-box; resize: vertical; border: 1px solid #ddd; }
        .copy-btn { 
            position: absolute; top: 2px; right: 2px; font-size: 9px; padding: 1px 4px; 
            background: #eee; border: 1px solid #bbb; cursor: pointer; border-radius: 2px; opacity: 0.7;
        }
        .copy-btn:hover { opacity: 1; background: #ddd; }

        .del-btn { background: #e74c3c; color: white; border: none; padding: 5px 8px; cursor: pointer; border-radius: 3px; }
        #status { font-weight: bold; color: #27ae60; }
    </style>
</head>
<body>

<div class="controls">
    <input type="text" id="newId" placeholder="Task ID (e.g. SH005)">
    <button onclick="addRow()" style="background: #27ae60; color: white; border: none; padding: 6px 15px; cursor: pointer; border-radius: 3px;">+ Add Task</button>
    <span id="status">● Linked to CSV</span>
</div>

<table id="checklistTable">
    <thead><tr id="headRow"></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
    const cols = ["Task ID", "HDI check", "Sensor-ROC check", "Module gluing", "Spacer gluing", "Wire bonding", "Pull test", "Carrier assembly", "Electrical test", "Shipped"];
    const names = ["IK", "CJ", "AR", "JM", "JB"];
    // Initial Rows
    let rowData = [
        {id: "SH004", rowNotes: ""}, {id: "SH003", rowNotes: ""}, 
        {id: "SH002", rowNotes: ""}, {id: "SH001", rowNotes: ""}
    ];

    function initHeader() {
        const hr = document.getElementById('headRow');
        cols.forEach(c => hr.innerHTML += `<th>${c}</th>`);
        hr.innerHTML += `<th>Checklist Notes</th><th>Action</th>`;
    }

    function render() {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        rowData.forEach((row, rIdx) => {
            let tr = document.createElement('tr');
            cols.forEach(col => {
                let td = document.createElement('td');
                if (col === "Task ID") {
                    td.innerHTML = `<strong>${row.id}</strong>`;
                } else {
                    const cell = row[col] || {t:'', n:'', m:''};
                    td.innerHTML = `
                        <div class="cell-container">
                            <input type="datetime-local" value="${cell.t}" onchange="update(${rIdx},'${col}','t',this.value)">
                            <select onchange="update(${rIdx},'${col}','n',this.value)">
                                <option value="">Select Name</option>
                                ${names.map(n => `<option value="${n}" ${cell.n===n?'selected':''}>${n}</option>`).join('')}
                            </select>
                            <div class="note-wrapper">
                                <textarea onchange="update(${rIdx},'${col}','m',this.value)">${cell.m}</textarea>
                                <button class="copy-btn" onclick="copyNote(this)">copy</button>
                            </div>
                        </div>`;
                }
                tr.appendChild(td);
            });
            // General Row Notes
            tr.innerHTML += `<td><textarea style="height:80px" onchange="updateRowNote(${rIdx}, this.value)">${row.rowNotes}</textarea></td>`;
            // Remove Column (Most Right)
            tr.innerHTML += `<td><button class="del-btn" onclick="removeRow(${rIdx})">Delete</button></td>`;
            body.appendChild(tr);
        });
    }

    function update(rIdx, col, field, val) {
        if(!rowData[rIdx][col]) rowData[rIdx][col] = {t:'', n:'', m:''};
        rowData[rIdx][col][field] = val;
        sync();
    }

    function updateRowNote(rIdx, val) {
        rowData[rIdx].rowNotes = val;
        sync();
    }

    function addRow() {
        const idInput = document.getElementById('newId');
        if(!idInput.value) return;
        // Newest to the top
        rowData.unshift({id: idInput.value, rowNotes: ""});
        idInput.value = '';
        render();
        sync();
    }

    function removeRow(rIdx) {
        if(confirm("Remove row?")) {
            rowData.splice(rIdx, 1);
            render();
            sync();
        }
    }

    function copyNote(btn) {
        const txt = btn.previousElementSibling.value;
        navigator.clipboard.writeText(txt);
        btn.innerText = "Done!";
        setTimeout(() => btn.innerText = "copy", 1000);
    }

    async function sync() {
        const status = document.getElementById('status');
        status.innerText = "● Syncing...";
        status.style.color = "orange";
        await fetch('/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(rowData)
        });
        status.innerText = "● Saved to CSV";
        status.style.color = "#27ae60";
    }

    initHeader();
    render();
</script>
</body>
</html>