<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Module Production Checklist</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f7f6; }
        table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 12px; }
        th { background-color: #2c3e50; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .cell-container { display: flex; flex-direction: column; gap: 5px; min-width: 140px; }
        input, select, textarea { width: 100%; box-sizing: border-box; font-size: 11px; }
        .copy-btn { cursor: pointer; background: #e0e0e0; border: none; padding: 2px; border-radius: 3px; font-size: 10px; margin-top: 2px; }
        .copy-btn:hover { background: #ccc; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .remove-btn { color: white; background: #e74c3c; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body>

    <h2>Production Checklist Management</h2>
    
    <div class="controls">
        <input type="text" id="newTaskID" placeholder="New Task ID (e.g. SH005)">
        <button onclick="addRow()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 3px;">+ Add Row</button>
        <span id="status" style="color: #7f8c8d; font-style: italic;">Synced with CSV</span>
    </div>

    <table id="checklistTable">
        <thead>
            <tr id="headerRow">
                </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

<script>
    const columns = ["Task ID", "HDI check", "Sensor-ROC check", "Module gluing", "Spacer gluing", "Wire bonding", "Pull test", "Carrier assembly", "Electrical test", "Shipped"];
    const names = ["IK", "CJ", "AR", "JM", "JB"];
    let data = [
        { "Task ID": "SH004" }, { "Task ID": "SH003" }, { "Task ID": "SH002" }, { "Task ID": "SH001" }
    ];

    function initTable() {
        const header = document.getElementById('headerRow');
        columns.forEach(col => {
            let th = document.createElement('th');
            th.innerText = col;
            header.appendChild(th);
        });
        header.insertAdjacentHTML('beforeend', '<th>General Notes</th><th>Action</th>');
        renderRows();
    }

    function renderRows() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            
            columns.forEach((col) => {
                const td = document.createElement('td');
                if (col === "Task ID") {
                    td.innerHTML = `<strong>${row[col] || ''}</strong>`;
                } else {
                    const cellData = row[col] || { time: '', name: '', note: '' };
                    td.innerHTML = `
                        <div class="cell-container">
                            <input type="datetime-local" value="${cellData.time}" onchange="updateCell(${rowIndex}, '${col}', 'time', this.value)">
                            <select onchange="updateCell(${rowIndex}, '${col}', 'name', this.value)">
                                <option value="">-Name-</option>
                                ${names.map(n => `<option value="${n}" ${cellData.name === n ? 'selected' : ''}>${n}</option>`).join('')}
                            </select>
                            <textarea placeholder="Note" onchange="updateCell(${rowIndex}, '${col}', 'note', this.value)">${cellData.note || ''}</textarea>
                            <button class="copy-btn" onclick="copyNote('${rowIndex}-${col}')">ðŸ“‹ Copy Note</button>
                            <input type="hidden" id="note-${rowIndex}-${col}" value="${cellData.note || ''}">
                        </div>`;
                }
                tr.appendChild(td);
            });

            // General Note Column
            const noteTd = document.createElement('td');
            noteTd.innerHTML = `<textarea onchange="updateRowNote(${rowIndex}, this.value)">${row.generalNote || ''}</textarea>`;
            tr.appendChild(noteTd);

            // Remove Column
            const actionTd = document.createElement('td');
            actionTd.innerHTML = `<button class="remove-btn" onclick="removeRow(${rowIndex})">Delete</button>`;
            tr.appendChild(actionTd);

            tbody.appendChild(tr);
        });
    }

    function updateCell(idx, col, field, val) {
        if (!data[idx][col]) data[idx][col] = {};
        data[idx][col][field] = val;
        syncWithHost();
    }

    function updateRowNote(idx, val) {
        data[idx].generalNote = val;
        syncWithHost();
    }

    function addRow() {
        const id = document.getElementById('newTaskID').value;
        if (!id) return alert("Enter Task ID");
        data.unshift({ "Task ID": id }); // Newest to top
        renderRows();
        syncWithHost();
    }

    function removeRow(idx) {
        if(confirm("Delete this row?")) {
            data.splice(idx, 1);
            renderRows();
            syncWithHost();
        }
    }

    function copyNote(id) {
        const text = document.querySelector(`[onclick="copyNote('${id}')"]`).previousElementSibling.value;
        navigator.clipboard.writeText(text);
        alert("Note copied to clipboard!");
    }

    async function syncWithHost() {
        document.getElementById('status').innerText = "Syncing...";
        try {
            await fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            document.getElementById('status').innerText = "Changes saved to CSV";
        } catch (e) {
            document.getElementById('status').innerText = "Sync Error!";
        }
    }

    initTable();
</script>
</body>
</html>
